# 自定义页面场景

Rokid CXR-M SDK 提供自定义界面能力，允许移动端通过 JSON 描述页面并下发到眼镜端显示，无需额外开发眼镜端应用。

> 在使用自定义页面前，请确保蓝牙链接已建立，并根据需要上传图片资源。

## 1. 打开自定义界面

`openCustomView(content)` 接受 JSON 描述字符串。首次打开建议先上传所需图标（参见第 5 节）。

```kotlin
fun openCustomView(content: String): ValueUtil.CxrStatus {
    return CxrApi.getInstance().openCustomView(content)
}
```

- `content`：界面初始化 JSON 字符串。
- 返回值 `ValueUtil.CxrStatus` 表示请求是否成功、等待或失败。

## 2. 监听界面状态

注册 `CustomViewListener` 可获知自定义界面的生命周期事件，例如图标发送完成、界面成功打开、更新完成等。

```kotlin
private val customViewListener = object : CustomViewListener {
    override fun onIconsSent() { /* 图标已下发 */ }
    override fun onOpened() { /* 页面已打开 */ }
    override fun onOpenFailed(errorCode: Int) { /* 打开失败 */ }
    override fun onUpdated() { /* 页面已更新 */ }
    override fun onClosed() { /* 页面已关闭 */ }
}

fun setCustomViewListener(enable: Boolean) {
    CxrApi.getInstance().setCustomViewListener(
        if (enable) customViewListener else null
    )
}
```

## 3. 更新界面

使用 `updateCustomView(content)` 更新已打开界面的特定控件。`content` 为 JSON 数组，指定操作类型、目标控件 ID 以及修改属性。

```kotlin
fun updateCustomView(content: String): ValueUtil.CxrStatus {
    return CxrApi.getInstance().updateCustomView(content)
}
```

示例更新 JSON：

```json
[
  {
    "action": "update",
    "id": "tv_title",
    "props": { "text": "Update Text" }
  },
  {
    "action": "update",
    "id": "iv_icon",
    "props": { "name": "icon_name1" }
  }
]
```

## 4. 关闭界面

```kotlin
fun closeCustomView(): ValueUtil.CxrStatus {
    return CxrApi.getInstance().closeCustomView()
}
```

## 5. 上传图片资源

若界面包含图片，需要提前调用 `sendCustomViewIcons(icons)` 上传。建议：
- 图像尺寸 ≤ 128×128 px
- 控制数量 ≤ 10 张

```kotlin
fun sendCustomIcons(icons: List<IconInfo>): ValueUtil.CxrStatus? {
    return CxrApi.getInstance().sendCustomViewIcons(icons)
}
```

`IconInfo` 字段：
- `name`：图标唯一标识，与布局或更新时引用的 `name` 对应。
- `data`：图片的 Base64 数据。眼镜端只使用绿色通道渲染。

## 6. 初始化布局 JSON

注意，页面描述使用Json。

布局支持：LinearLayout和RelativeLayout。

<table>
    <tbody>
        <tr>
            <th>控件</th>
            <th>参数</th>
            <th>值</th>
        </tr>
        <tr>
            <td rowspan="8">LinearLayout</td>
            <td>id</td>
            <td>[id]</td>
        </tr>
        <tr>
            <td>layout_width <br>layout_height</td>
            <td>match_parent <br>wrap_content <br>[value]dp</td>
        </tr>
        <tr>
            <td>layout_gravity(控制子控件gravity) <br>gravity</td>
            <td>start<br>top<br>end<br>bottom<br>center<br>center_horizontal<br>center_vertical</td>
        </tr>
        <tr>
            <td>orientation</td>
            <td>vertical<br>horizontal</td>
        </tr>
        <tr>
            <td>marginStart<br>marginTop<br>marginEnd<br>marginBottom</td>
            <td>[value]dp</td>
        </tr>
        <tr>
            <td>layout_weight(控制子控件weight)</td>
            <td>[value]</td>
        </tr>
        <tr>
            <td>paddingStart<br>paddingTop<br>paddingEnd<br>paddingBottom</td>
            <td>[value]dp</td>
        </tr>
        <tr>
            <td>backgroundColor</td>
            <td>#FF000000</td>
        </tr>
        <tr>
            <td rowspan="7">RelativeLayout</td>
            <td>id</td>
            <td>[id]</td>
        </tr>
        <tr>
            <td>layout_width<br>layout_height</td>
            <td>match_parent<br>wrap_content<br>[value]dp</td>
        </tr>
        <tr>
            <td>paddingStart<br>paddingEnd<br>paddingTop<br>paddingBottom</td>
            <td>[value]dp</td>
        </tr>
        <tr>
            <td>backgroundColor</td>
            <td>#FF000000</td>
        </tr>
        <tr>
            <td>marginStart<br>marginEnd<br>marginTop<br>marginBottom</td>
            <td>[value]dp</td>
        </tr>
        <tr>
            <td>layout_toStartOf<br>layout_above<br>layout_toEndOf<br>layout_below<br>layout_alignBaseLine<br>layout_alignStart<br>layout_alignEnd<br>layout_alignTop<br>layout_alignBottom</td>
            <td>[id]</td>
        </tr>
        <tr>
            <td>layout_alignParentStart<br>layout_alignParentEnd<br>layout_alignParentTop<br>layout_alignParentBottom<br>layout_centerInParent<br>layout_centerHorizontal<br>layout_centerVertical</td>
            <td>true<br>false</td>
        </tr>
    </tbody>
</table>

<table>
    <tbody>
        <tr>
            <th>控件</th>
            <th>参数</th>
            <th>值</th>
        </tr>
        <tr>
            <td rowspan="8">LinearLayout</td>
            <td>id</td>
            <td>[id]</td>
        </tr>
        <tr>
            <td>layout_width <br>layout_height</td>
            <td>match_parent <br>wrap_content <br>[value]dp</td>
        </tr>
        <tr>
            <td>layout_gravity(控制子控件gravity) <br>gravity</td>
            <td>start<br>top<br>end<br>bottom<br>center<br>center_horizontal<br>center_vertical</td>
        </tr>
        <tr>
            <td>orientation</td>
            <td>vertical<br>horizontal</td>
        </tr>
        <tr>
            <td>marginStart<br>marginTop<br>marginEnd<br>marginBottom</td>
            <td>[value]dp</td>
        </tr>
        <tr>
            <td>layout_weight(控制子控件weight)</td>
            <td>[value]</td>
        </tr>
        <tr>
            <td>paddingStart<br>paddingTop<br>paddingEnd<br>paddingBottom</td>
            <td>[value]dp</td>
        </tr>
        <tr>
            <td>backgroundColor</td>
            <td>#FF000000</td>
        </tr>
        <tr>
            <td rowspan="7">RelativeLayout</td>
            <td>id</td>
            <td>[id]</td>
        </tr>
        <tr>
            <td>layout_width<br>layout_height</td>
            <td>match_parent<br>wrap_content<br>[value]dp</td>
        </tr>
        <tr>
            <td>paddingStart<br>paddingEnd<br>paddingTop<br>paddingBottom</td>
            <td>[value]dp</td>
        </tr>
        <tr>
            <td>backgroundColor</td>
            <td>#FF000000</td>
        </tr>
        <tr>
            <td>marginStart<br>marginEnd<br>marginTop<br>marginBottom</td>
            <td>[value]dp</td>
        </tr>
        <tr>
            <td>layout_toStartOf<br>layout_above<br>layout_toEndOf<br>layout_below<br>layout_alignBaseLine<br>layout_alignStart<br>layout_alignEnd<br>layout_alignTop<br>layout_alignBottom</td>
            <td>[id]</td>
        </tr>
        <tr>
            <td>layout_alignParentStart<br>layout_alignParentEnd<br>layout_alignParentTop<br>layout_alignParentBottom<br>layout_centerInParent<br>layout_centerHorizontal<br>layout_centerVertical</td>
            <td>true<br>false</td>
        </tr>
    </tbody>
</table>

控件支持TextView、ImageView

<table>
    <tbody>
        <tr>
            <th>控件</th>
            <th>参数</th>
            <th>值</th>
        </tr>
        <tr>
            <td rowspan="9">TextView</td>
            <td>id</td>
            <td>[id]</td>
        </tr>
        <tr>
            <td>layout_width<br>layout_height</td>
            <td>match_parent<br>wrap_content<br>[value]dp</td>
        </tr>
        <tr>
            <td>text</td>
            <td>[text]</td>
        </tr>
        <tr>
            <td>textColor</td>
            <td>#FF00FF00</td>
        </tr>
        <tr>
            <td>textSize</td>
            <td>[value]sp</td>
        </tr>
        <tr>
            <td>gravity</td>
            <td>start<br>top<br>end<br>bottom<br>center<br>center_horizontal<br>center_vertical</td>
        </tr>
        <tr>
            <td>textStyle</td>
            <td>bold<br>italic</td>
        </tr>
        <tr>
            <td>paddingStart<br>paddingEnd<br>paddingTop<br>paddingBottom</td>
            <td>[value]dp</td>
        </tr>
        <tr>
            <td>marginStart<br>marginEnd<br>marginTop<br>marginBottom</td>
            <td>[value]dp</td>
        </tr>
        <tr>
            <td rowspan="4">ImageView</td>
            <td>id</td>
            <td>[id]</td>
        </tr>
        <tr>
            <td>layout_width<br>layout_height</td>
            <td>match_parent<br>wrap_content<br>[value]dp</td>
        </tr>
        <tr>
            <td>name</td>
            <td>[icon_name]</td>
        </tr>
        <tr>
            <td>scaleType</td>
            <td>matrix<br>fix_xy<br>fix_start<br>fix_center<br>fix_end<br>center<br>center_crop<br>center_inside</td>
        </tr>
    </tbody>
</table>

### 初始化示例

```json
{
  "type": "LinearLayout",
  "props": {
    "layout_width": "match_parent",
    "layout_height": "match_parent",
    "orientation": "vertical",
    "gravity": "center_horizontal",
    "paddingTop": "140dp",
    "paddingBottom": "100dp",
    "backgroundColor": "#FF000000"
  },
  "children": [
    {
      "type": "TextView",
      "props": {
        "id": "tv_title",
        "layout_width": "wrap_content",
        "layout_height": "wrap_content",
        "text": "Init Text",
        "textSize": "16sp",
        "textColor": "#FF00FF00",
        "textStyle": "bold",
        "marginBottom": "20dp"
      }
    },
    {
      "type": "RelativeLayout",
      "props": {
        "layout_width": "match_parent",
        "layout_height": "100dp",
        "backgroundColor": "#00000000",
        "paddingStart": "10dp",
        "paddingEnd": "10dp"
      },
      "children": [
        {
          "type": "ImageView",
          "props": {
            "id": "iv_icon",
            "layout_width": "60dp",
            "layout_height": "60dp",
            "name": "icon_name0",
            "layout_alignParentStart": "true",
            "layout_centerVertical": "true"
          }
        },
        {
          "type": "TextView",
          "props": {
            "id": "tv_text",
            "layout_width": "wrap_content",
            "layout_height": "wrap_content",
            "text": "Text to the end of Icon",
            "textSize": "16sp",
            "textColor": "#FF00FF00",
            "layout_toEndOf": "iv_icon",
            "layout_centerVertical": "true",
            "marginStart": "15dp"
          }
        }
      ]
    }
  ]
}
```

## 7. 更新布局 JSON

更新时仅需传递变更项。示例：

```json
[
  {
    "action": "update",
    "id": "tv_title",
    "props": { "text": "Update Text" }
  },
  {
    "action": "update",
    "id": "iv_icon",
    "props": { "name": "icon_name1" }
  }
]
```

---

### 开发建议

- **模板管理**：建议在本地维护 JSON 模板，动态填充业务数据后再下发，减少拼接错误。
- **异常处理**：`openCustomView` / `updateCustomView` 返回 `REQUEST_WAITING` 时无需重复调用，可通过监听等待结果。
- **资源规划**：图片上传仅需一次，可在应用初始化或首个场景加载时完成。
- **效果校验**：自定义界面依赖眼镜端渲染效果，开发阶段可通过截图或录屏确认布局是否符合预期。

